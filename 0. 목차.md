# 0. 목차

## **0. 학습 개요**

- STM32F103C8T6 (“Blue Pill”) 소개
- STM32CubeIDE + HAL + FreeRTOS 개발환경 구성
- 디버깅 환경(ST-LINK, UART, printf 리디렉션)
- 프로젝트 기반 학습 로드맵
  - 센서 계측 → 데이터 처리 → FreeRTOS → 제어 → 최적화

------

## **1. STM32 마이크로컨트롤러 기본기**

### 1.1 MCU 아키텍처 개요

- Cortex-M3 핵심 구조 (레지스터, 스택, 인터럽트 벡터)
- STM32F1 시리즈의 버스 구조 (AHB, APB1, APB2)
- 메모리 맵 구조 (Flash, SRAM, Peripheral)
- RCC(Reset and Clock Control) 동작원리
- 부트 모드 (Boot0/Boot1, ISP, Flash 부팅)

### 1.2 펌웨어 프로젝트 구성

- startup_stm32f1xx.s — Reset Vector & 초기화 루틴
- system_stm32f1xx.c — PLL 및 클럭 초기화
- stm32f1xx_it.c — 인터럽트 핸들러 정의
- syscalls.c / sysmem.c — printf, malloc 등 재구현
- main.c 구조 및 함수 호출 흐름 (`HAL_Init()`, `SystemClock_Config()`)

### 1.3 CMSIS와 HAL 구조

- CMSIS-Core, Device, DSP의 역할
- HAL 계층과 LL (Low Layer) 비교
- CubeMX가 생성하는 초기화 코드 분석
- HAL 함수 구조 및 리턴 코드 이해
- HAL_Delay(), HAL_GetTick(), SysTick Handler 이해

------

## **2. GPIO 제어와 디지털 입출력**

### 2.1 GPIO 기본

- Port와 Pin 구조
- Input, Output, Alternate, Analog 모드
- Push-Pull vs Open-Drain
- Pull-Up/Pull-Down 개념 및 회로 연결
- `__HAL_RCC_GPIOx_CLK_ENABLE()` 원리

### 2.2 HAL GPIO 함수

- `HAL_GPIO_ReadPin()`, `HAL_GPIO_WritePin()`
- `HAL_GPIO_TogglePin()` 실습
- 디바운스 처리, 반복 스캔 구현

### 2.3 EXTI (외부 인터럽트)

- EXTI 라인 맵핑 (PA0~PA15)
- NVIC 우선순위 설정
- HAL_GPIO_EXTI_Callback() 구조
- 버튼 인터럽트 및 LED 토글 실습

### 2.4 실습

- LED 제어
- 스위치 인터럽트로 펌프 ON/OFF
- 수위센서 트리거 입력 (디지털 감지)

------

## **3. Timer (정밀 시간 및 PWM 제어)**

### 3.1 기본 타이머 개념

- Prescaler, ARR, CNT 구조
- Up/Down 카운터
- Overflow 이벤트
- 타이머 클럭 계산법

### 3.2 타이머 모드

- Output Compare / PWM / Input Capture / One Pulse
- TIM Interrupt / DMA 트리거
- Timer → µs 단위 Delay 함수 작성

### 3.3 HAL Timer 함수

- `HAL_TIM_Base_Start()`, `HAL_TIM_PWM_Start()`
- `HAL_TIM_IC_Start()`, `HAL_TIM_PeriodElapsedCallback()`

### 3.4 실습

- delay_us() 함수 구현
- HC-SR04 초음파 거리 측정
- PWM으로 서보모터 제어
- Timer 인터럽트로 주기적 Task 실행

------

## **4. ADC (Analog to Digital Converter)**

### 4.1 ADC 구조

- 샘플링, 홀드, 변환 과정
- 분해능(Resolution), 변환속도, 채널 선택
- 내부 온도센서 및 Vref 측정

### 4.2 HAL ADC 함수

- `HAL_ADC_Start()`, `HAL_ADC_PollForConversion()`
- `HAL_ADC_GetValue()`, `HAL_ADC_Stop()`
- Polling, Interrupt, DMA 방식 비교

### 4.3 전압 측정 실습

- 분압회로 설계 (10k / 2.2k)
- `Read_Voltage()` 함수 구조
- 전압 보정식 `(ADC_Value * 11.67 / 2065) + 0.36`
- 아날로그 전압 + LM35 온도센서 측정

------

## **5. I²C 통신 (센서 데이터 인터페이스)**

### 5.1 I²C 기본

- SDA/SCL 동작, Start/Stop/ACK 프레임
- 7-bit, 10-bit Address 구조
- HAL I²C 주소 시프트 규칙 (`addr << 1`)
- 타임아웃, 버스 정지 복구 기법

### 5.2 HAL I²C 함수

- `HAL_I2C_Master_Transmit()`
- `HAL_I2C_Master_Receive()`
- `HAL_I2C_Mem_Read()`, `HAL_I2C_Mem_Write()`

### 5.3 실습

- 24C02 EEPROM 읽기/쓰기
- OLED SSD1306 “Hello” 출력
- VL53L0X 거리센서 데이터 읽기
- I²C 듀얼센서 (0x48, 0x49) 수위센서 병렬 테스트

------

## **6. 센서 드라이버 개발**

### 6.1 초음파 센서 (HC-SR04)

- TRIG 펄스 생성, ECHO 펄스폭 측정
- Timer Input Capture 기반 거리 계산
- MAX_TIMEOUT 처리

### 6.2 로드셀 (HX711)

- 24bit ADC 인터페이스
- Offset / Scale 보정
- 평균 필터링 (Moving Average)
- 무게 계산 함수 `HX711_Get_Value()`

### 6.3 ToF 센서 (VL53L0X)

- I²C 레지스터 접근
- 초기화 및 Calibration
- 단발/연속 측정 모드
- 신호율, VCSEL 파라미터 이해

### 6.4 수위센서 (Capacitive Water Sensor)

- 20단 정전식 수위 검출
- Dual I²C Address 병합
- Threshold 기반 마지막 감지단 탐색
- 수위(mm) 계산식: `height = last_on * 5 + 3`

### 6.5 센서 결합 테스트

- 초음파 + 수위 + 무게 통합
- I²C 충돌 방지 및 Multi-Slave 테스트

------

## **7. RTC (Real-Time Clock)**

### 7.1 RTC 기본

- LSE 32.768kHz 클럭 설정
- 백업 도메인 및 배터리 유지
- RTC 구조체 (`RTC_TimeTypeDef`, `RTC_AlarmTypeDef`)

### 7.2 HAL 함수

- `HAL_RTC_SetTime()`, `HAL_RTC_GetTime()`
- `HAL_RTC_SetAlarm_IT()`
- 알람 인터럽트 동작 (`RTC_Alarm_IRQHandler`)

### 7.3 실습

- `Set_RTC()` / `Set_Alarm()` 함수 구현
- 슬립 → 알람 깨움 → 측정 루틴 수행
- 저전력 시스템 구현

------

## **8. FreeRTOS 실전**

### 8.1 FreeRTOS 구조

- 커널 구조, Task, Scheduler
- Tick, SysTick Handler
- Context Switch & Stack 관리

### 8.2 STM32 포팅

- CubeMX로 FreeRTOS 활성화
- heap_4.c 메모리 모델
- CMSIS-RTOS2 API (`osThreadNew()`, `osDelay()`)

### 8.3 실습 및 구조화

- Task 분리
  - SensorTask : 센서 데이터 취득
  - DisplayTask : UART / OLED 출력
  - ControlTask : 밸브/펌프 제어
  - RTCTask : 알람 스케줄링
- Queue / Mutex / Semaphore 사용
- Tickless Idle (Sleep) 적용

------

## **9. 인터럽트 / 예외 / Fault Handling**

### 9.1 예외 (Exceptions)

- HardFault / BusFault / UsageFault 분석
- Stack Frame 복구 (PC, LR, PSR)
- 디버깅 시 Fault 추적 방법

### 9.2 인터럽트 처리

- NVIC 우선순위 및 Enable
- HAL_IRQ_Handler 호출 체계
- RTC Alarm IRQ, UART RX IRQ, EXTI IRQ 실습

### 9.3 실습

- RTC 알람 인터럽트 → Task Notify
- 초음파 ECHO 인터럽트 기반 측정
- UART RX Complete Callback 로깅

------

## **10. 센서 데이터 처리 및 보정**

### 10.1 보정 알고리즘

- Offset Calibration
- Scale Calibration
- EEPROM에 Calibration 데이터 저장

### 10.2 필터링

- Moving Average
- Exponential Smoothing
- Simple Kalman Filter (1차)

### 10.3 타임아웃 및 재시도

- HAL I²C Timeout 처리
- 재시도 루프, 오류 카운터
- Fail-Safe 제어 루틴

------

## **11. 통합 실습 프로젝트**

### 11.1 Smart Tank (스마트 수조)

- 초음파 + 수위센서 + HX711 통합
- FreeRTOS Task 병렬 실행
- RTC 기반 주기 측정
- OLED + UART 상태 출력
- 밸브 제어 (Relay/MOSFET)

### 11.2 Sensor Node (저전력 계측 노드)

- RTC 알람 기반 Wake-up
- STOP 모드 진입 / 복귀
- 측정 → 전송 → Sleep
- 소비전류 측정 및 최적화

### 11.3 자동 수위 제어 시스템

- 목표 수위 입력
- PID 제어 (간단 비례제어)
- 펌프 구동 및 차단
- 경보 / 상태 모니터링

------

## **12. 디버깅 및 최적화**

### 12.1 디버깅

- ST-LINK 실시간 디버깅
- UART 로그 출력 (`printf`)
- CubeIDE Watch / Live Variables

### 12.2 성능 분석

- Timer 정확도 검증
- Task 주기성 측정
- CPU 부하 측정

### 12.3 최적화

- DMA 적용 (ADC, I²C)
- Tickless Idle Mode
- Static Task Allocation

------

## **13. 확장 및 통신**

### 13.1 SPI / UART 확장

- SPI 기반 IMU (MPU6050)
- UART 기반 BLE/Wi-Fi 연동

### 13.2 EEPROM / Flash 데이터 관리

- Calibration / Log 저장
- Flash Page Write/Erase 실습

### 13.3 SD카드 로깅

- SPI-SD 인터페이스
- FATFS로 데이터 저장
- CSV 로깅

### 13.4 IoT 연동

- ESP32 MQTT 브릿지
- RS485 Modbus RTU 연결
- 클라우드 모니터링 (Grafana)

------

## **14. 산업 시스템 통합**

### 14.1 센서퓨전

- 초음파 + ToF + 수위센서 융합
- 신뢰도 기반 필터링
- Adaptive Threshold 적용

### 14.2 HMI 및 로깅

- OLED / LCD 표시
- PC Serial Plotter 시각화
- 데이터로그 기반 분석

### 14.3 산업 안정성

- 보호회로 (TVS, ESD, 퓨즈)
- 노이즈 차단 (LC 필터)
- 전원 안정화 및 EMC 대응

------

## **15. 종합 아키텍처 설계**

### 15.1 펌웨어 구조

```
Application
 ├─ Tasks (FreeRTOS)
 ├─ Sensor Drivers (Ultrasonic, HX711, Water, ToF)
 ├─ HAL Wrappers (GPIO, ADC, I2C, TIM)
 ├─ RTC / Sleep Controller
 └─ Logging / Control Modules
```

### 15.2 하드웨어 매핑

| 센서         | 인터페이스    | 포트        |
| ------------ | ------------- | ----------- |
| HC-SR04      | GPIO + TIM    | PB9 / PB8   |
| HX711        | GPIO          | PA1 / PA2   |
| VL53L0X      | I²C1          | PB6 / PB7   |
| Water Sensor | I²C2          | PB10 / PB11 |
| Voltage      | ADC1          | PA0         |
| RTC          | LSE 32.768kHz | PC14 / PC15 |
| Pump Relay   | GPIO          | PB12        |
| OLED         | I²C1 (공유)   | PB6 / PB7   |

------

## **16. 부록**

- HAL 주요 헤더 분석 (`stm32f1xx_hal_conf.h`, `stm32f1xx_hal_def.h`)
- CMSIS-Core 함수 정리
- NVIC 벡터 테이블 전체 목록
- Register-Level 접근 실습
- 보정 데이터 저장 예제 (EEPROM / Flash)
- FreeRTOS 메모리 사용량 분석표
- 전력 소비 측정 리포트

------

### ✅ 요약

| 단계      | 학습 주제              | 결과물                    |
| --------- | ---------------------- | ------------------------- |
| 1~4단계   | MCU, GPIO, Timer, ADC  | 펌웨어 기본기 완성        |
| 5~7단계   | I²C, 센서, RTC         | 계측 시스템 구축          |
| 8단계     | FreeRTOS               | 병렬 멀티태스킹 구현      |
| 9~10단계  | 인터럽트, 필터링, 보정 | 안정된 데이터 처리        |
| 11~12단계 | 통합 프로젝트          | 완전한 계측 제어 시스템   |
| 13~14단계 | 통신 / 산업화          | IoT 확장 및 실무화        |
| 15단계    | 아키텍처 정리          | 유지보수 가능한 구조 설계 |